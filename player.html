<html>
<head>
    <script src="https://www.unpkg.com/dashjs/dist/dash.mediaplayer.min.js"></script>
    <script src="https://unpkg.com/flv.js/dist/flv.min.js"></script>
    <script src="https://unpkg.com/hls.js/dist/hls.min.js"></script>
    <title>NPlayer</title>
    <style>
    body {
        background-color: black;
        margin: 0;
    }
    #message {
        visibility: hidden;
        color: white;
        text-align: center;
        font-size: 1.5em;
        position: fixed;
        left: 50%;
        transform: translate(-50%, -50%);
        bottom: 10vh;
    }
    #video {
        height: 100vh;
        width: 100vw;
    }
    #video-wrapper {
        font-size: 0;
    }
    </style>
</head>
<body>
    <div id="video-wrapper">
        <video id="video"></video>
    </div>
    <div id="message"></div>
    <script>
    let url = null;
    const playbackRate = [1, 1.25, 1.5, 1.75, 2, 0.25, 0.5, 0.75];
    let overlayMessageTimeout;
    let playbackRateIndex = 1;
    let player;
    const video = document.getElementById("video");
    window.onload = loadPlayer;
    window.onmouseup = function() {
        document.activeElement.blur();
    };
    window.onkeydown = async function(e) {
        e.preventDefault();
        let key = e.which || e.keyCode;
        if (key === 32) {
            video.paused ? video.play() : video.pause();
            overlayMessage(video.paused ? "Paused" : "Playing");
        } else if ([37, 39].indexOf(key) > -1 && isFinite(video.duration)) {
            let multiplier = key === 39 ? 1 : -1;
            let skip = e.ctrlKey ? 120 : 5;
            let seekTime = video.currentTime + (multiplier * skip);
            video.currentTime = seekTime < 0 ? 0 : seekTime;
            overlayMessage(secondsToTime(video.currentTime) + (isFinite(video.duration) ? " | " + secondsToTime(video.duration) : ""));
        } else if ([38, 40].indexOf(key) > -1 && isFinite(video.duration)) {
            let multiplier = key === 38 ? 1 : -1;
            let skip = e.ctrlKey ? 300 : 20;
            let seekTime = video.currentTime + (multiplier * skip);
            video.currentTime = seekTime < 0 ? 0 : seekTime;
            overlayMessage(secondsToTime(video.currentTime) + (isFinite(video.duration) ? " | " + secondsToTime(video.duration) : ""));
        } else if ([188, 190].indexOf(key) > -1 && isFinite(video.duration)) {
            let multiplier = key === 188 ? 1 : -1;
            let seekTime = video.currentTime + (multiplier / 60);
            video.currentTime = seekTime < 0 ? 0 : seekTime;
            overlayMessage(secondsToTime(video.currentTime) + (isFinite(video.duration) ? " | " + secondsToTime(video.duration) : ""));
        } else if ([48, 49, 50, 51, 52, 53, 54, 55, 56, 57].indexOf(key) > -1 && isFinite(video.duration)) {
            video.currentTime = video.duration * (key - 48) / 10.0;
        } else if (key === 67) {
            saveToClipboard(url);
        } else if (key === 70) {
            document.fullscreenElement ? document.exitFullscreen() : video.requestFullscreen();
        } else if (key === 72) {
            overlayMessage("{Space}: Play/Pause<br>{ArrowLeft/ArrowRight} (+ Ctrl): Skip 5 (or 120) seconds<br>{ArrowDown/ArrowUp} (+ Ctrl): Skip 20 (or 300) seconds<br>{t}: Display current time<br>{m}: Toggle mute<br>{f}: Toggle fullscreen<br>{c}: Saved to clipboard<br>{l}: Load new link<br>{s}: Toggle playback rate<br>{r}: Reload player");
        } else if (key === 76) {
            let link = prompt("Link:", "");
            if (link && link.length) {
                url = link;
                await loadPlayer();
                overlayMessage("Loaded");
            }
        } else if (key === 77) {
            video.muted ? video.muted = false : video.muted = true;
            overlayMessage(video.muted ? "Muted" : "Unmuted");
        } else if (key === 82) {
            await loadPlayer();
            overlayMessage("Reloaded");
        } else if (key === 83) {
            video.playbackRate = playbackRate[playbackRateIndex++ % playbackRate.length];
            overlayMessage("Playback rate: " + video.playbackRate);
        } else if (key === 84) {
            overlayMessage(secondsToTime(video.currentTime) + (isFinite(video.duration) ? " | " + secondsToTime(video.duration) : ""));
        }
    };
    window.onorientationchange = function() {
        let orientation = (window.screen.orientation || {}).type || window.screen.mozOrientation || window.screen.msOrientation;
        if (["landscape-primary", "landscape-secondary"].indexOf(orientation) !== -1) {
            video.requestFullscreen();
        }
    };
    async function loadPlayer() {
        try {
            if (location.hash.length) {
                url = location.hash.slice(1);
            }
            if (url && url.length) {
                let x = document.getElementById("message");
                x.innerHTML = "Loading...";
                x.style.visibility = "visible";
                let playType;
                let match = new RegExp(".(3gp|aac|flv|m3u8|m4a|m4r|m4v|mkv|mov|mp3|mp4|mpd|oga|ogg|ogv|opus|wav|webm)(#|" + String.fromCharCode(92) + "?|$)", "i").exec(url);
                switch (match ? match[1] : null) {
                    case "3gp":
                        playType = "video/3gpp";
                        break;
                    case "aac":
                        playType = "audio/aac";
                        break;
                    case "flv":
                        playType = "video/x-flv";
                        break;
                    case "m3u8":
                        playType = "application/x-mpegURL";
                        break;
                    case "m4a":
                    case "m4r":
                    case "m4v":
                    case "mp4":
                        playType = "video/mp4";
                        break;
                    case "mkv":
                        playType = "video/x-matroska";
                        break;
                    case "mov":
                        playType = "video/quicktime";
                        break;
                    case "mp3":
                        playType = "audio/mpeg";
                        break;
                    case "mpd":
                        playType = "application/dash+xml";
                        break;
                    case "oga":
                    case "ogg":
                    case "ogv":
                    case "opus":
                        playType = "application/ogg";
                        break;
                    case "wav":
                        playType = "audio/x-wav";
                        break;
                    case "webm":
                        playType = "video/webm";
                        break;
                    default:
                        let response = await fetch(url, {
                            method: "HEAD"
                        });
                        playType = response.headers.get("content-type");
                        console.log("playType", playType);
                }
                document.title = url;
                location.hash = "#" + url;
                video.volume = 1;
                video.controls = 1;
                if (player) player.destroy();
                if (playType == "video/x-flv") {
                    player = flvjs.createPlayer({
                        type: "flv",
                        url: url
                    });
                    player.attachMediaElement(video);
                    player.load();
                } else if (["application/vnd.apple.mpegurl", "application/x-mpegURL"].indexOf(playType) > -1) {
                    player = new Hls();
                    player.loadSource(url);
                    player.attachMedia(video);
                } else if (playType == "application/dash+xml") {
                    player = dashjs.MediaPlayer().create();
                    player.initialize(video, url, false);
                } else {
                    video.src = url;
                    video.load();
                }
                x.style.visibility = "hidden";
                video.play();
            }
        } catch (err) {
            console.log("loadPlayer", err.toString());
        }
    }

    function overlayMessage(msg) {
        let x = document.getElementById("message");
        x.innerHTML = msg;
        x.style.visibility = "visible";
        clearTimeout(overlayMessageTimeout);
        overlayMessageTimeout = setTimeout(function() {
            x.style.visibility = "hidden";
        }, 2000);
    }

    function saveToClipboard(string) {
        if (string && string.length) {
            let textArea = document.createElement("textarea");
            textArea.value = string;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                let copy = document.execCommand("copy");
                overlayMessage(copy ? "Copied" : "Failed to copy");
            } catch (err) {
                overlayMessage("Failed to copy");
            }
            document.body.removeChild(textArea);
        }
    }

    function secondsToTime(secs) {
        return new Date(secs * 1000).toISOString().slice(11, 19);
    }
    </script>
</body>
</html>
